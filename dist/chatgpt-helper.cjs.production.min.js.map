{"version":3,"file":"chatgpt-helper.cjs.production.min.js","sources":["../src/index.ts"],"sourcesContent":["import {\n  OpenAIApi,\n  ChatCompletionFunctions,\n  CreateChatCompletionRequest,\n  ChatCompletionResponseMessage,\n} from 'openai';\nimport { zodToJsonSchema } from 'zod-to-json-schema';\nimport { z } from 'zod';\n\n//TODO: have a strict type\ntype AnyZodObject = any;\n\nfunction getParameterFromZod(schema: AnyZodObject) {\n  const {\n    $schema: _$schema,\n    //@ts-ignore\n    additionalProperties: _additionalProps,\n    ...jsonSchema\n  } = zodToJsonSchema(schema);\n  return jsonSchema;\n}\n\nfunction createExtractor({\n  purpose: description,\n  schema,\n}: {\n  purpose: string;\n  schema: AnyZodObject;\n}): ChatCompletionFunctions {\n  const parameters = getParameterFromZod(schema);\n  return {\n    name: 'metadata_extract',\n    description,\n    parameters,\n  };\n}\n\ntype ToolImplementation = (\n  a?: any\n) => Promise<Record<string, any>> | Record<string, any>;\n\ntype ToolDefenitionArgs = {\n  name: string;\n  purpose: string;\n  argSchema?: AnyZodObject;\n  implementation: ToolImplementation;\n};\n\nexport class Tools {\n  tools: ChatCompletionFunctions[];\n  functions: Record<string, ToolImplementation>;\n\n  constructor() {\n    this.tools = [];\n    this.functions = {};\n  }\n\n  addTool({\n    name,\n    purpose: description,\n    argSchema: schema = z.object({}),\n    implementation,\n  }: ToolDefenitionArgs) {\n    this.functions[name] = implementation;\n    const parameters = getParameterFromZod(schema);\n    this.tools.push({\n      name,\n      description,\n      parameters,\n    });\n    return this;\n  }\n}\n\ntype RunWithToolsUntilCompleteArgs = {\n  api: OpenAIApi;\n  prompt: string;\n  tools: Tools;\n} & Partial<\n  Exclude<CreateChatCompletionRequest, 'functions' | 'function_call'>\n>;\n\nconst DEFAULT_MODEL = 'gpt-3.5-turbo-0613';\n\nexport async function runWithToolsUntilComplete({\n  api,\n  prompt,\n  tools,\n  model = DEFAULT_MODEL,\n  messages = [],\n  ...opts\n}: RunWithToolsUntilCompleteArgs) {\n  let complete = false;\n  messages = [...messages, { role: 'user', content: prompt }];\n  let lastMessage: ChatCompletionResponseMessage | undefined = undefined;\n  while (!complete) {\n    const chatCompletion = await api.createChatCompletion({\n      model,\n      messages,\n      functions: tools.tools,\n      function_call: 'auto',\n      ...opts,\n    });\n\n    const { message } = chatCompletion.data.choices?.[0];\n    lastMessage = message;\n    if (message) {\n      messages = [...messages, message];\n      if (message.function_call) {\n        const { name: functionName, arguments: _args = '{}' } =\n          message.function_call;\n        const functionArgument: Record<string, any> = JSON.parse(_args);\n        const functionResult = await tools.functions[functionName!](\n          functionArgument\n        );\n        messages = [\n          ...messages,\n          {\n            role: 'function',\n            name: functionName,\n            content: JSON.stringify(functionResult),\n          },\n        ];\n      } else {\n        complete = true;\n      }\n    } else {\n      throw new Error('MessageResponseEmpty');\n    }\n  }\n  return { messages, lastMessage };\n}\n\nexport async function extractDataWithPrompt({\n  api,\n  schema,\n  prompt: content,\n  metadataDescription: purpose = '',\n  ...opts\n}: {\n  api: OpenAIApi;\n  schema: AnyZodObject;\n  prompt: string;\n  metadataDescription?: string;\n} & Partial<\n  Omit<CreateChatCompletionRequest, 'messages' | 'functions' | 'function_call'>\n>) {\n  const fn = createExtractor({ purpose, schema });\n  const { model = DEFAULT_MODEL, ...otherOpts } = opts;\n  const chatCompletion = await api.createChatCompletion({\n    model,\n    messages: [{ role: 'user', content }],\n    functions: [fn],\n    function_call: { name: fn.name },\n    ...otherOpts,\n  });\n  if (chatCompletion.data?.choices?.[0]?.message?.function_call) {\n    const { message } = chatCompletion.data.choices?.[0];\n    return { data: message!.function_call!.arguments, message };\n  } else {\n    throw new Error('ResultEmpty');\n  }\n}\n"],"names":["getParameterFromZod","schema","_objectWithoutPropertiesLoose","zodToJsonSchema","_excluded","DEFAULT_MODEL","_runWithToolsUntilComplete","_asyncToGenerator","_regeneratorRuntime","mark","_callee","_ref3","api","prompt","tools","_ref3$model","model","_ref3$messages","messages","opts","complete","lastMessage","_chatCompletion$data$2","_chatCompletion$data$","message","_message$function_cal","functionName","_message$function_cal2","functionArgument","wrap","_context","prev","next","_excluded2","concat","role","content","undefined","createChatCompletion","_extends","functions","function_call","sent","data","choices","name","arguments","JSON","parse","stringify","Error","abrupt","stop","apply","this","_extractDataWithPrompt","_callee2","_ref4","_chatCompletion$data","_chatCompletion$data$3","_chatCompletion$data$4","_chatCompletion$data$5","_ref4$metadataDescrip","purpose","fn","_opts$model","otherOpts","chatCompletion","_chatCompletion$data$7","_chatCompletion$data$6","_context2","metadataDescription","_excluded3","description","_ref","parameters","_excluded4","Tools","prototype","addTool","_ref2","_ref2$argSchema","argSchema","z","object","implementation","push","extractDataWithPrompt","_x2","runWithToolsUntilComplete","_x"],"mappings":"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"}